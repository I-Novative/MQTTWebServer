<%- include('partials/_header') %>
<body>
    <script src="/socket.io/socket.io.js"></script>
    <a href="/guests/">Guests</a>
    <a href="/rooms/">Rooms</a>
    <a href="/checkIns/">Check In</a>
    <a href="/sensors/">Sensores</a>
    <a href="/totals/">Totals</a>
    <a href="/checkOuts/">Check Out</a>
    <a href="/unexpectedTowel/">Unexpected towel</a>
    <a href="/unexpectedWater/">Unexpected water</a>
    <script>

        let socket = io();

        const towelByGuestEndPoint = 'http://localhost:3000/api/towelConsumption/guest/';
        const waterByGuestEndPoint = 'http://localhost:3000/api/waterConsumption/guest/';
        const towelByDayEndPoint = 'http://localhost:3000/api/towelConsumption/day/';
        const waterByDayEndPoint = 'http://localhost:3000/api/waterConsumption/day/'
        const towelsByRoomEndPoint = 'http://localhost:3000/api/towelConsumption/room/';
        const waterByRoomEndPoint = 'http://localhost:3000/api/waterConsumption/room/';

        // Get todays date formatted to yyyy-mm-dd
        const date = new Date();
        date.setHours(date.getHours() - new Date().getTimezoneOffset()/60);
        const formmatedDate = date.toISOString().slice(0, 10);

        const towelByHourEndPoint = `http://localhost:3000/api/towelConsumption/hour/${formmatedDate}/`;
        const waterByHourEndPoint = `http://localhost:3000/api/waterConsumption/hour/${formmatedDate}/`;

        window.addEventListener('load', async function () {

            try {

                let jsonData = {};

                const [
                    towelByGuestResponse, 
                    waterByGuestResponse, 
                    towelByDayResponse,
                    towelByHourResponse,
                    waterByDayResponse,
                    waterByHourResponse,
                    towelByRoomResponse,
                    waterByRoomResponse
                ] = await Promise.all([
                    fetch(towelByGuestEndPoint),
                    fetch(waterByGuestEndPoint),
                    fetch(towelByDayEndPoint),
                    fetch(towelByHourEndPoint),
                    fetch(waterByDayEndPoint),
                    fetch(waterByHourEndPoint),
                    fetch(towelsByRoomEndPoint),
                    fetch(waterByRoomEndPoint)
                ]);

                if(towelByGuestResponse.status == 200) {
                    jsonData = await towelByGuestResponse.json();
                    loadTowelsXAgeChart(jsonData);
                    loadTowelsXCountryChart(jsonData);
                }
                if(waterByGuestResponse.status == 200) {
                    jsonData = await waterByGuestResponse.json();
                    loadWaterXAgeChart(jsonData);
                    loadWaterXCountryChart(jsonData);
                }
                if(towelByDayResponse.status == 200) {
                    jsonData = await towelByDayResponse.json();
                    loadTowelsXDayChart(jsonData);
                }
                if(towelByHourResponse.status == 200) {
                    jsonData = await towelByHourResponse.json();
                    loadTowelsXHourChart(jsonData);
                }
                if(waterByDayResponse.status == 200) {
                    jsonData = await waterByDayResponse.json();
                    loadWaterXDayChart(jsonData);
                }
                if(waterByHourResponse.status == 200) {
                    jsonData = await waterByHourResponse.json();
                    loadWaterXHourChart(jsonData);
                }
                if(towelByRoomResponse.status == 200) {
                    jsonData = await towelByRoomResponse.json();
                    loadTowelsXRoomChart(jsonData);
                }
                if(waterByRoomResponse.status == 200) {
                    jsonData = await waterByRoomResponse.json();
                    loadWaterXRoomChart(jsonData);
                }

            } catch (error) { console.log(`Error: ${error}`); }
        }, false);

        const getAgeIndex = (age) => {
            let index = 0;
            if(age < 20) index = 0;
            else if (age >= 20 && age <= 30) index = 1;
            else if(age >= 31 && age <= 40) index = 2;
            else if(age >= 41 && age <= 50) index = 3;
            else if(age >= 51 && age <= 60) index = 4;
            else if(age >= 61 && age <= 70) index = 5;
            else if(age > 70) index = 6;
            return index;
        };

        // Look for a label in the chart labels array and return the index
        const getElementIndex = (element, chart) => {
            let index = 0;
            for (label of chart.data.labels) {
                if(element === label) return index; 
                index++;
            }
            return -1;
        };

    </script>

    <div style="width: 50%;">
        <canvas id="towelsXAge"></canvas>
        <canvas id="towelsXCountry"></canvas>
        <canvas id="waterXAge"></canvas>
        <canvas id="waterXCountry"></canvas>
        <canvas id="towelsXDay"></canvas>
        <canvas id="towelsXHour"></canvas>
        <canvas id="waterXDay"></canvas>
        <canvas id="waterXHour"></canvas>
        <canvas id="towelsXRoom"></canvas>
        <canvas id="waterXRoom"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="./charts/towelsXAge.js"></script>
    <script src="./charts/towelsXCountry.js"></script>
    <script src="./charts/waterXAge.js"></script>
    <script src="./charts/waterXCountry.js"></script>
    <script src="./charts/towelsXDay.js"></script>
    <script src="./charts/towelsXHour.js"></script>
    <script src="./charts/waterXDay.js"></script>
    <script src="./charts/waterXHour.js"></script>
    <script src="./charts/towelsXRoom.js"></script>
    <script src="./charts/waterXRoom.js"></script>

    <%- include('partials/_footer') %>

</body>
</html>